pipeline { 
  agent any

  environment {
    DEPLOY_USER        = 'ubuntu'
    DEPLOY_HOST        = '3.110.154.247'
    DEPLOY_PATH        = '/usr/share/nginx/html/'
    SSH_CREDENTIALS_ID = 'node-app-key'
    REPO_URL           = 'https://github.com/aniketchougule108/static-website-project-terraform-jenkins.git'
    BRANCH             = 'main'
  }

  stages {

    stage('Checkout Code') {
      steps {
        git branch: "${BRANCH}", url: "${REPO_URL}"
      }
    }

    stage('Prepare EC2 Server') {
      steps {
        withCredentials([
          sshUserPrivateKey(credentialsId: SSH_CREDENTIALS_ID,
                            keyFileVariable: 'SSH_KEY',
                            usernameVariable: 'SSH_USER')
        ]) {
          sh """
            ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" ${SSH_USER}@${DEPLOY_HOST} '
              sudo apt-get update -y
              sudo apt-get install -y nginx
              sudo systemctl enable nginx
              sudo systemctl start nginx
              sudo mkdir -p ${DEPLOY_PATH}
            '
          """
        }
      }
    }

    stage('Upload Website Files') {
      steps {
        withCredentials([
          sshUserPrivateKey(credentialsId: SSH_CREDENTIALS_ID,
                            keyFileVariable: 'SSH_KEY',
                            usernameVariable: 'SSH_USER')
        ]) {
          sh """
            echo "Uploading Website Files..."
            scp -o StrictHostKeyChecking=no -i "$SSH_KEY" -r * ${SSH_USER}@${DEPLOY_HOST}:/tmp/deploy_payload
          """
        }
      }
    }

    stage('Deploy to Nginx') {
      steps {
        withCredentials([
          sshUserPrivateKey(credentialsId: SSH_CREDENTIALS_ID,
                            keyFileVariable: 'SSH_KEY',
                            usernameVariable: 'SSH_USER')
        ]) {
          sh """
            ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" ${SSH_USER}@${DEPLOY_HOST} "
              set -e
              DEPLOY_PATH='${DEPLOY_PATH}'

              sudo rm -rf \\\"\$DEPLOY_PATH\\\"/*

              sudo mv /tmp/deploy_payload/* \\\"\$DEPLOY_PATH\\\"/ || true

              for f in index.htm HomePage.html Homepage.html home.html; do
                if [ -f \\\"\$DEPLOY_PATH/\$f\\\" ]; then
                  sudo mv \\\"\$DEPLOY_PATH/\$f\\\" \\\"\$DEPLOY_PATH/index.html\\\"
                fi
              done

              sudo chown -R www-data:www-data \\\"\$DEPLOY_PATH\\\"
              sudo find \\\"\$DEPLOY_PATH\\\" -type d -exec chmod 755 {} \\\\;
              sudo find \\\"\$DEPLOY_PATH\\\" -type f -exec chmod 644 {} \\\\;

              sudo systemctl restart nginx
              sudo rm -rf /tmp/deploy_payload || true

              echo DEPLOYMENT_DONE
            "
          """
        }
      }
    }

    stage('Smoke Test') {
      steps {
        sh "curl -I http://${DEPLOY_HOST} | head -n 5 || true"
      }
    }
  }

  post {
    success {
      echo "✅ Deployment successful: http://${DEPLOY_HOST}"
    }
    failure {
      echo "❌ Deployment failed — check console output"
    }
  }
}
